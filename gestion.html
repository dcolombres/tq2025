<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Contenido - Tutti Quanti</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f4f7f9; margin: 0; padding: 2rem; }
        .main-container, .words-container { margin: auto; width: 100%; max-width: 900px; }
        .container { background-color: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 4px A12px rgba(0,0,0,0.08); margin-bottom: 2rem; }
        h1, h2 { color: #3F2A56; text-align: center; margin-bottom: 1.5rem; }
        table { width: 100%; border-collapse: collapse; font-size: 1rem; }
        thead { background-color: #3F2A56; color: white; }
        th, td { padding: 12px 15px; border: 1px solid #e0e0e0; text-align: left; vertical-align: middle; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        tbody tr:hover { background-color: #f1f1f1; transition: background-color 0.2s; }
        .actions-cell { text-align: center; white-space: nowrap; }
        .actions-cell button { font-size: 0.85rem; padding: 8px 12px; margin: 0 4px; border-radius: 5px; cursor: pointer; border: none; transition: all 0.2s ease; }
        .actions-cell button i { margin-right: 5px; }
        .btn-edit, .btn-edit-word { background-color: #ffc107; color: #333; }
        .btn-edit:hover, .btn-edit-word:hover { background-color: #e0a800; transform: translateY(-1px); }
        .btn-delete, .btn-delete-word { background-color: #dc3545; color: white; }
        .btn-delete:hover, .btn-delete-word:hover { background-color: #c82333; transform: translateY(-1px); }
        .btn-manage { background-color: #17a2b8; color: white; }
        .btn-manage:hover { background-color: #138496; transform: translateY(-1px); }
        .btn-back { background-color: #6c757d; color: white; margin-bottom: 1rem; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .btn-back:hover { background-color: #5a6268; }
        .add-word-form { display: flex; gap: 10px; margin-bottom: 1.5rem; }
        .add-word-form input { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        .add-word-form button { background-color: #28a745; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; }
        .add-word-form button:hover { background-color: #218838; }
        .edit-word-input { width: 90%; padding: 8px; border-radius: 4px; border: 1px solid #3F2A56; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); } 
        .modal-content { background-color: #fefefe; margin: 10% auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="main-view">
    <div class="main-container">
        <h1>Panel de Gestión</h1>
        <div class="container">
            <h2>Subcategorías</h2>
            <table id="subcategorias-table"><thead><tr><th>Categoría</th><th>Nivel</th><th>Subcategoría</th><th>Palabras</th><th style="text-align:center;">Valid. Externa</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="container">
            <h2>Niveles</h2>
            <table id="niveles-table"><thead><tr><th>Nombre</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
        </div>
        <div class="container">
            <h2>Categorías Principales</h2>
            <table id="categorias-table"><thead><tr><th>Nombre</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<div id="words-view" style="display: none;">
    <div class="words-container">
        <button class="btn-back" id="back-to-main"><i class="fas fa-arrow-left"></i> Volver</button>
        <div class="container">
            <h2 id="words-view-title">Gestionar Palabras</h2>
            <form id="add-word-form" class="add-word-form">
                <input type="text" id="new-word-input" placeholder="Añadir nueva palabra..." required>
                <button type="submit"><i class="fas fa-plus"></i> Añadir</button>
            </form>
            <table id="words-table"><thead><tr><th>Palabra</th><th class="actions-cell">Acciones</th></tr></thead><tbody></tbody></table>
        </div>
    </div>
</div>

<div id="edit-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h2>Editar Nombre</h2>
    <form id="edit-form">
        <input type="hidden" id="edit-item-id" name="id">
        <input type="hidden" id="edit-item-type" name="type">
        <div class="form-group">
            <label for="edit-item-name">Nuevo Nombre:</label>
            <input type="text" id="edit-item-name" name="name" required>
        </div>
        <button type="submit"><i class="fas fa-save"></i> Guardar Cambios</button>
    </form>
  </div>
</div>

<script>
    // Views
    const mainView = document.getElementById('main-view');
    const wordsView = document.getElementById('words-view');

    // Table Bodies
    const categoriasTableBody = document.querySelector('#categorias-table tbody');
    const nivelesTableBody = document.querySelector('#niveles-table tbody');
    const subcategoriasTableBody = document.querySelector('#subcategorias-table tbody');
    const wordsTableBody = document.querySelector('#words-table tbody');

    // State
    let currentSubcategoryId = null;

    // --- Table Loading Functions ---
    function loadCategoriasTable() {
        fetch('get_items.php?type=categoria').then(res => res.json()).then(data => {
            categoriasTableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                row.innerHTML = `<td>${item.nombre}</td><td class="actions-cell"><button class="btn-edit" data-type="categoria"><i class="fas fa-pencil-alt"></i> Editar</button> <button class="btn-delete" data-type="categoria"><i class="fas fa-trash-alt"></i> Eliminar</button></td>`;
                categoriasTableBody.appendChild(row);
            });
        });
    }

    function loadNivelesTable() {
        fetch('get_items.php?type=nivel').then(res => res.json()).then(data => {
            nivelesTableBody.innerHTML = '';
            data.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                row.innerHTML = `<td>${item.nombre}</td><td class="actions-cell"><button class="btn-edit" data-type="nivel"><i class="fas fa-pencil-alt"></i> Editar</button> <button class="btn-delete" data-type="nivel"><i class="fas fa-trash-alt"></i> Eliminar</button></td>`;
                nivelesTableBody.appendChild(row);
            });
        });
    }

    function loadSubcategoriasTable() {
        fetch('test_logic.php').then(response => response.json()).then(data => {
            subcategoriasTableBody.innerHTML = '';
            if (data.length === 0) {
                subcategoriasTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay datos para mostrar.</td></tr>';
                return;
            }
            data.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.id = item.subcategoria_id;
                const checkedAttribute = item.permite_validacion_externa == 1 ? 'checked' : '';
                row.innerHTML = `<td>${item.categoria}</td><td>${item.nivel}</td><td>${item.subcategoria}</td><td style="text-align:center;">${item.cantidad_palabras}</td><td style="text-align:center;"><input type="checkbox" class="validation-checkbox" data-id="${item.subcategoria_id}" ${checkedAttribute}></td><td class="actions-cell"><button class="btn-manage"><i class="fas fa-tasks"></i> Gestionar</button> <button class="btn-edit" data-type="subcategory"><i class="fas fa-pencil-alt"></i></button> <button class="btn-delete" data-type="subcategory"><i class="fas fa-trash-alt"></i></button></td>`;
                subcategoriasTableBody.appendChild(row);
            });
        });
    }

    function loadWordsTable(subcategoryId) {
        currentSubcategoryId = subcategoryId;
        fetch(`get_words.php?subcategoria_id=${subcategoryId}`).then(res => res.json()).then(data => {
            wordsTableBody.innerHTML = '';
            if (data.error) { alert('Error: ' + data.error); return; }
            data.forEach(word => {
                const row = document.createElement('tr');
                row.dataset.id = word.id;
                row.innerHTML = `<td><span class="word-text">${word.palabra}</span></td><td class="actions-cell"><button class="btn-edit-word"><i class="fas fa-pencil-alt"></i> Editar</button> <button class="btn-delete-word"><i class="fas fa-trash-alt"></i> Eliminar</button></td>`;
                wordsTableBody.appendChild(row);
            });
        });
    }

    function loadAllTables() { loadCategoriasTable(); loadNivelesTable(); loadSubcategoriasTable(); }

    // --- View Navigation ---
    document.getElementById('back-to-main').addEventListener('click', () => {
        mainView.style.display = 'block';
        wordsView.style.display = 'none';
        currentSubcategoryId = null;
        loadSubcategoriasTable();
    });

    // --- Event Delegation ---
    document.body.addEventListener('click', (event) => {
        const target = event.target.closest('button');
        if (!target) return;

        const row = target.closest('tr');
        const itemId = row ? row.dataset.id : null;

        // Manage Words Button
        if (target.classList.contains('btn-manage')) {
            const subcategoryName = row.cells[2].textContent;
            mainView.style.display = 'none';
            wordsView.style.display = 'block';
            document.getElementById('words-view-title').textContent = `Gestionando Palabras para: ${subcategoryName}`;
            loadWordsTable(itemId);
        }

        // Main Delete Logic
        if (target.classList.contains('btn-delete')) {
            const itemType = target.dataset.type;
            const itemName = itemType === 'subcategory' ? row.cells[2].textContent : row.cells[0].textContent;
            const confirmMessage = itemType === 'subcategory' 
                ? `¿Estás seguro de que quieres eliminar la subcategoría "${itemName}" y todas sus palabras?`
                : `ATENCIÓN: ¿Estás seguro de que quieres eliminar '${itemName}'? Se borrarán TODOS los niveles, subcategorías y palabras que contenga. Esta acción es irreversible.`;

            if (confirm(confirmMessage)) {
                fetch(`delete_item.php?type=${itemType}&id=${itemId}`).then(res => res.json()).then(data => {
                    if (data.success) { loadAllTables(); } else { alert('Error al eliminar: ' + data.message); }
                }).catch(error => alert('Ocurrió un error de red.'));
            }
        }

        // Main Edit Logic
        if (target.classList.contains('btn-edit')) {
            const itemType = target.dataset.type;
            const nameToEdit = itemType === 'subcategory' ? row.cells[2].textContent : row.cells[0].textContent;
            document.getElementById('edit-item-id').value = itemId;
            document.getElementById('edit-item-type').value = itemType;
            document.getElementById('edit-item-name').value = nameToEdit;
            document.getElementById('edit-modal').style.display = "block";
        }

        // Delete Word Logic
        if (target.classList.contains('btn-delete-word')) {
            if (confirm(`¿Estás seguro de que quieres eliminar la palabra "${row.cells[0].textContent}"?`)) {
                fetch('delete_word.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ word_id: itemId }) })
                .then(res => res.json()).then(data => {
                    if (data.success) { loadWordsTable(currentSubcategoryId); } else { alert('Error al eliminar: ' + data.message); }
                }).catch(error => alert('Ocurrió un error de red.'));
            }
        }

        // Edit Word Logic (In-line)
        if (target.classList.contains('btn-edit-word')) {
            const wordCell = row.cells[0];
            const wordTextSpan = wordCell.querySelector('.word-text');
            const oldWord = wordTextSpan.textContent;
            
            wordCell.innerHTML = `<input type="text" class="edit-word-input" value="${oldWord}">`;
            target.innerHTML = '<i class="fas fa-save"></i> Guardar';
            target.classList.remove('btn-edit-word');
            target.classList.add('btn-save-word');
        }

        // Save Word Logic
        if (target.classList.contains('btn-save-word')) {
            const input = row.cells[0].querySelector('input');
            const newWord = input.value.trim();
            const oldWord = Array.from(wordsTableBody.querySelectorAll('tr')).find(r => r.dataset.id === itemId).querySelector('.word-text')?.textContent;

            if (newWord && newWord !== oldWord) {
                fetch('edit_word.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ word_id: itemId, new_palabra: newWord }) })
                .then(res => res.json()).then(data => {
                    if (data.success) { loadWordsTable(currentSubcategoryId); } else { alert('Error al editar: ' + data.message); loadWordsTable(currentSubcategoryId); } // Recargar incluso si hay error para revertir
                }).catch(error => { alert('Ocurrió un error de red.'); loadWordsTable(currentSubcategoryId); });
            } else {
                loadWordsTable(currentSubcategoryId); // Revertir si no hay cambios
            }
        }
    });

    // --- Checkbox Event Listener ---
    subcategoriasTableBody.addEventListener('change', (event) => {
        if (event.target.classList.contains('validation-checkbox')) {
            const checkbox = event.target;
            const subcategoryId = checkbox.dataset.id;
            const isChecked = checkbox.checked;

            const originalColor = checkbox.closest('tr').style.backgroundColor;

            fetch('update_validation_flag.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subcategoria_id: subcategoryId, is_checked: isChecked })
            })
            .then(res => res.json())
            .then(data => {
                const row = checkbox.closest('tr');
                if (data.success) {
                    row.style.backgroundColor = '#d4edda'; // Light green for success
                    setTimeout(() => { row.style.backgroundColor = originalColor; }, 2000);
                } else {
                    alert('Error al guardar el cambio: ' + data.message);
                    row.style.backgroundColor = '#f8d7da'; // Light red for error
                    setTimeout(() => { loadSubcategoriasTable(); }, 2000); // Reload to revert state
                }
            })
            .catch(err => {
                alert('Error de red. No se pudo guardar el cambio.');
                loadSubcategoriasTable();
            });
        }
    });

    // --- Modal Logic ---
    const modal = document.getElementById('edit-modal');
    document.querySelector('.close-button').onclick = () => modal.style.display = "none";
    window.onclick = (event) => { if (event.target == modal) modal.style.display = "none"; }
    document.getElementById('edit-form').addEventListener('submit', (event) => {
        event.preventDefault();
        fetch('edit_item.php', { method: 'POST', body: new FormData(document.getElementById('edit-form')) })
        .then(res => res.json()).then(data => {
            if (data.success) { loadAllTables(); modal.style.display = "none"; } else { alert('Error al editar: ' + data.message); }
        }).catch(error => alert('Ocurrió un error de red.'));
    });

    // --- Add Word Logic ---
    document.getElementById('add-word-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const input = document.getElementById('new-word-input');
        if (input.value.trim() === '' || !currentSubcategoryId) return;
        fetch('add_word.php', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ subcategoria_id: currentSubcategoryId, palabra: input.value.trim() }) })
        .then(res => res.json()).then(data => {
            if (data.success) { input.value = ''; loadWordsTable(currentSubcategoryId); } else { alert('Error al añadir: ' + data.message); }
        }).catch(error => alert('Ocurrió un error de red.'));
    });

    // Initial Load
    loadAllTables();
</script>

</body>
</html>
